{% extends "base.html" %}

{% block title %}Dashboard - Hệ thống quản lý nước Phố Nối{% endblock %}

{% block extra_head %}
<style>
    .system-diagram {
        background: var(--bs-secondary);
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        min-height: 400px;
        position: relative;
    }

    .diagram-zone {
        position: absolute;
        background: var(--bs-primary);
        color: white;
        border-radius: 8px;
        padding: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        font-size: 12px;
    }

    .diagram-zone:hover {
        background: var(--bs-info);
        transform: scale(1.05);
    }

    .kpi-card {
        transition: transform 0.2s ease;
    }

    .kpi-card:hover {
        transform: translateY(-2px);
    }

    .quick-actions {
        position: fixed;
        bottom: 24px;
        right: 24px;
        /* đổi sang .left để ghim bên trái */
        z-index: 1050;
    }

    .quick-actions.left {
        right: auto;
        left: 24px;
    }

    .qa-fab {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 8px 24px rgba(0, 0, 0, .2);
    }

    .qa-panel {
        width: 260px;
        max-width: 90vw;
        border-radius: 16px;
        box-shadow: 0 16px 40px rgba(0, 0, 0, .25);
        overflow: hidden;
    }

    /* Ẩn panel mặc định */
    .qa-panel.collapse:not(.show) {
        display: none;
    }

    .qa-link i {
        width: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <p class="col-12">
    <h1><i class="fas fa-chart-line text-primary me-2"></i>Dashboard Hệ thống Cấp Thoát Nước</h1>
    <p class="text-muted"></p>
    <!-- <p class="text-muted">Chào mừng {{ current_user.full_name or current_user.username }} - {{ current_user.role.value.replace('_', ' ').title() }}</p> -->
</div>
</div>

<!-- Chọn ngày xem dữ liệu -->
<div class="row mb-3">
    <div class="col-md-4">
        <!-- <label for="dashboard-date" class="form-label">Chọn ngày</label> -->
        <div class="input-group">
            <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
            <input type="date" class="form-control" id="dashboard-date">
        </div>
    </div>
</div>

<!-- KPI Cards -->
<div class="row mb-4" id="kpi-section">
    <div class="col-md-3">
        <div class="card kpi-card bg-primary">
            <div class="card-body text-center text-white">
                <i class="fas fa-water fa-2x mb-2"></i>
                <h4 id="today-well-production">0</h4>
                <p class="mb-0">Sản lượng giếng (m³)</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card bg-info">
            <div class="card-body text-center text-white">
                <i class="fas fa-tint fa-2x mb-2"></i>
                <h4 id="today-clean-water">0</h4>
                <p class="mb-0">Nước sạch cung cấp (m³)</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card bg-warning">
            <div class="card-body text-center text-white">
                <i class="fas fa-recycle fa-2x mb-2"></i>
                <h4 id="today-wastewater">0</h4>
                <p class="mb-0">Nước thải xử lý (m³)</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card bg-success">
            <div class="card-body text-center text-white">
                <i class="fas fa-users fa-2x mb-2"></i>
                <h4 id="active-customers">0</h4>
                <p class="mb-0">Khách hàng hoạt động</p>
            </div>
        </div>
    </div>
</div>

<!-- System Diagram -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-sitemap me-2"></i>Sơ đồ Hệ thống Cấp Thoát Nước</h5>
                <!-- <small class="text-muted">Click vào các khu vực để nhập dữ liệu</small> -->
            </div>
            <div class="card-body p-3" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                <div class="system-diagram d-flex justify-content-center align-items-center" id="system-diagram"
                    style="min-height: 500px;">
                    <div id="water-system-svg" style="width: 90%; height: auto;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Chưa cho xem vì chưa hoàn thiện chart -->
{% if current_user.role.value in ['leadership', 'plant_manager', 'admin'] %}
<div class="col-12 mt-4">
    <div class="card shadow-sm" id="summaryCard">
        <div class="card-body">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line text-primary me-2"></i>
                        Hệ thống Cấp - Thoát Nước
                    </h5>
                    <div>
                        <button id="toggleChartBtn" class="btn btn-outline-secondary btn-sm me-2">
                            <i class="fas fa-compress-alt"></i> Thu gọn
                        </button>
                        <select id="periodSelect" class="form-select form-select-sm d-inline-block" style="width:auto;">
                            <option value="current">Kỳ hiện tại (25 này)</option>
                            <option value="previous">Kỳ trước</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="summaryChartWrapper" class="mt-3" style="transition: all .3s ease;">
                <div id="summarySixLinesChart" style="height: 360px;"></div>
            </div>
        </div>
    </div>
</div>
{% endif %}



<!-- Chart Controls -->
{% if current_user.role.value in ['leadership', 'admin'] %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-filter me-2"></i>Bộ lọc biểu đồ</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Khoảng thời gian</label>
                        <select class="form-select" id="chart-period">
                            <option value="7">7 ngày qua</option>
                            <option value="30" selected>30 ngày qua</option>
                            <option value="90">90 ngày qua</option>
                            <option value="365">1 năm qua</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Từ ngày</label>
                        <input type="date" class="form-control" id="chart-start-date">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Đến ngày</label>
                        <input type="date" class="form-control" id="chart-end-date">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="updateChartsWithCustomRange()">
                            <i class="fas fa-sync me-2"></i>Cập nhật
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6><i class="fas fa-water me-2"></i>Sản lượng tổng các giếng khoan theo ngày</h6>
                <div>
                    <button class="btn btn-sm btn-primary" onclick="viewChartDetails('wells')">
                        <i class="fas fa-chart-line me-1"></i>Xem chi tiết
                    </button>
                </div>
            </div>
            <div class="card-body" style="height: 350px;">
                <canvas id="wellProductionChart"></canvas>
                <small class="text-muted">Đơn vị: m³/ngày. Hiển thị tổng sản lượng 5 giếng hoạt động (GK1, GK2, GK3,
                    GK5, GK6, GK7)</small>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6><i class="fas fa-tint me-2"></i>Sản lượng nước sạch cấp cho Khách hàng</h6>
                <div>
                    <button class="btn btn-sm btn-primary" onclick="viewChartDetails('clean-water')">
                        <i class="fas fa-chart-bar me-1"></i>Xem chi tiết
                    </button>
                </div>
            </div>
            <div class="card-body" style="height: 350px;">
                <canvas id="cleanWaterChart"></canvas>
                <small class="text-muted">Đơn vị: m³/ngày</small>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6><i class="fas fa-recycle me-2"></i>Lưu lượng nước thải qua nhà máy xử lý</h6>
                <div>
                    <button class="btn btn-sm btn-primary" onclick="viewChartDetails('wastewater')">
                        <i class="fas fa-chart-area me-1"></i>Xem chi tiết
                    </button>
                </div>
            </div>
            <div class="card-body" style="height: 350px;">
                <canvas id="wastewaterChart"></canvas>
                <small class="text-muted">Đơn vị: m³/ngày. Công suất xử lý NMNT1: 12,000 m³/ngày, NMNT2: 8,000 m³/ngày</small>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6><i class="fas fa-users me-2"></i>Tiêu thụ nước của Top 4 khách hàng lớn nhất</h6>
                <div>
                    <button class="btn btn-sm btn-primary" onclick="viewChartDetails('customers')">
                        <i class="fas fa-chart-pie me-1"></i>Xem chi tiết
                    </button>
                </div>
            </div>
            <div class="card-body" style="height: 350px;">
                <canvas id="customerChart"></canvas>
                <small class="text-muted">Tổng tiêu thụ 4 khách hàng. Nước thải tính theo tỷ lệ hoặc đồng hồ trực
                    tiếp</small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Quick Actions -->
<!-- {% if current_user.role.value in ['data_entry', 'plant_manager', 'admin'] %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-tasks me-2"></i>Thao tác nhanh</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <a href="{{ url_for('data_entry') }}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-edit me-2"></i>Nhập liệu hôm nay
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('data_entry') }}#wells" class="btn btn-outline-info w-100">
                            <i class="fas fa-water me-2"></i>Sản lượng giếng
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('data_entry') }}#customers" class="btn btn-outline-warning w-100">
                            <i class="fas fa-users me-2"></i>Chỉ số khách hàng
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('reports') }}" class="btn btn-outline-success w-100">
                            <i class="fas fa-file-alt me-2"></i>Tạo báo cáo
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %} -->
{% if current_user.role.value in ['data_entry', 'plant_manager', 'admin'] %}
<!-- QUICK ACTIONS: Floating Widget -->
<div class="quick-actions right"> {# đổi right -> left nếu muốn ghim bên trái #}
    <!-- Nút FAB để mở/đóng -->
    <button id="qaToggle" class="btn btn-primary qa-fab" aria-expanded="false" aria-controls="qaPanel"
        data-bs-toggle="tooltip" data-bs-placement="left">
        <i class="fas fa-bolt fa-lg"></i>
    </button>


    <!-- Panel nội dung -->
    <div id="qaPanel" class="qa-panel bg-white collapse mt-3">
        <div class="p-3 border-bottom d-flex align-items-center">
            <i class="fas fa-tasks me-2 text-primary"></i>
            <strong>Thao tác nhanh</strong>
            <button type="button" class="btn btn-sm btn-light ms-auto" id="qaClose" title="Đóng">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="list-group list-group-flush">
            <a href="{{ url_for('data_entry') }}" class="list-group-item list-group-item-action qa-link">
                <i class="fas fa-edit me-2 text-primary"></i> Nhập liệu hôm nay
            </a>
            <a href="{{ url_for('data_entry') }}#wells" class="list-group-item list-group-item-action qa-link">
                <i class="fas fa-water me-2 text-info"></i> Sản lượng giếng
            </a>
            <a href="{{ url_for('data_entry') }}#customers" class="list-group-item list-group-item-action qa-link">
                <i class="fas fa-users me-2 text-warning"></i> Chỉ số khách hàng
            </a>
            <a href="{{ url_for('reports') }}" class="list-group-item list-group-item-action qa-link">
                <i class="fas fa-file-alt me-2 text-success"></i> Tạo báo cáo
            </a>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        loadKPIData();
        loadSystemDiagram();

        {% if current_user.role.value in ['leadership', 'plant_manager', 'admin'] %}
        loadDashboardCharts();
        {% endif %}
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const qaToggle = document.getElementById('qaToggle');
        const qaPanel = document.getElementById('qaPanel');
        const qaClose = document.getElementById('qaClose');

        // Khởi tạo tooltip Bootstrap
        if (qaToggle && window.bootstrap && bootstrap.Tooltip) {
            new bootstrap.Tooltip(qaToggle);
        }

        // Toggle panel
        if (qaToggle && qaPanel) {
            qaToggle.addEventListener('click', function (e) {
                e.stopPropagation(); // tránh nổi bọt lên document
                const isShown = qaPanel.classList.contains('show');
                qaPanel.classList.toggle('show', !isShown);
                qaToggle.setAttribute('aria-expanded', String(!isShown));
                qaToggle.style.visibility = isShown ? 'visible' : 'hidden';
            });
        }

        // Nút X đóng panel
        if (qaClose && qaPanel) {
            qaClose.addEventListener('click', function (e) {
                e.stopPropagation();
                qaPanel.classList.remove('show');
                qaToggle.setAttribute('aria-expanded', 'false');
                qaToggle.style.visibility = 'visible';
            });
        }

        // Bấm ra ngoài để đóng
        document.addEventListener('click', function (e) {
            if (!qaPanel) return;
            const clickedOutside = !qaPanel.contains(e.target) && !qaToggle.contains(e.target);
            if (qaPanel.classList.contains('show') && clickedOutside) {
                qaPanel.classList.remove('show');
                qaToggle.setAttribute('aria-expanded', 'false');
                qaToggle.style.visibility = 'visible';
            }
        });

        // Đóng khi bấm Esc
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && qaPanel && qaPanel.classList.contains('show')) {
                qaPanel.classList.remove('show');
                qaToggle.setAttribute('aria-expanded', 'false');
                qaToggle.style.visibility = 'visible';
            }
        });
    });
</script>


{% endblock %}
