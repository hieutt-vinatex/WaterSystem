{% extends "base.html" %}

{% block title %}Dashboard - Hệ thống quản lý nước Phố Nối{% endblock %}

{% block extra_head %}
<style>
    .system-diagram {
        background: var(--bs-secondary);
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        min-height: 400px;
        position: relative;
    }
    .diagram-zone {
        position: absolute;
        background: var(--bs-primary);
        color: white;
        border-radius: 8px;
        padding: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        font-size: 12px;
    }
    .diagram-zone:hover {
        background: var(--bs-info);
        transform: scale(1.05);
    }
    .kpi-card {
        transition: transform 0.2s ease;
    }
    .kpi-card:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-chart-line text-primary me-2"></i>Dashboard Hệ thống Cấp Thoát Nước</h1>
        <p class="text-muted">Chào mừng {{ current_user.full_name or current_user.username }} - {{ current_user.role.value.replace('_', ' ').title() }}</p>
    </div>
</div>

<!-- KPI Cards -->
<div class="row mb-4" id="kpi-section">
    <div class="col-md-3">
        <div class="card kpi-card bg-primary">
            <div class="card-body text-center text-white">
                <i class="fas fa-water fa-2x mb-2"></i>
                <h4 id="today-well-production">0</h4>
                <p class="mb-0">Sản lượng giếng hôm nay (m³)</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card bg-info">
            <div class="card-body text-center text-white">
                <i class="fas fa-tint fa-2x mb-2"></i>
                <h4 id="today-clean-water">0</h4>
                <p class="mb-0">Nước sạch hôm nay (m³)</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card bg-warning">
            <div class="card-body text-center text-white">
                <i class="fas fa-recycle fa-2x mb-2"></i>
                <h4 id="today-wastewater">0</h4>
                <p class="mb-0">Nước thải xử lý hôm nay (m³)</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card bg-success">
            <div class="card-body text-center text-white">
                <i class="fas fa-users fa-2x mb-2"></i>
                <h4 id="active-customers">0</h4>
                <p class="mb-0">Khách hàng hoạt động</p>
            </div>
        </div>
    </div>
</div>

<!-- System Diagram -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5><i class="fas fa-sitemap me-2"></i>Sơ đồ Hệ thống Cấp Thoát Nước</h5>
                    <small class="text-muted">Click vào các khu vực để nhập dữ liệu</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="zoomDiagram()">
                        <i class="fas fa-search-plus"></i> Phóng to
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="resetDiagramZoom()">
                        <i class="fas fa-compress"></i> Thu nhỏ
                    </button>
                </div>
            </div>
            <div class="card-body p-2" style="min-height: 650px; max-height: 650px; overflow: auto; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                <div class="system-diagram w-100 h-100 d-flex justify-content-center align-items-center" id="system-diagram">
                    <div id="water-system-svg" style="width: 100%; height: 100%; transform-origin: center; transition: transform 0.3s ease;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart Controls -->
{% if current_user.role.value in ['leadership', 'plant_manager', 'admin'] %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-filter me-2"></i>Bộ lọc biểu đồ</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Khoảng thời gian</label>
                        <select class="form-select" id="chart-period">
                            <option value="7">7 ngày qua</option>
                            <option value="30" selected>30 ngày qua</option>
                            <option value="90">90 ngày qua</option>
                            <option value="365">1 năm qua</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Từ ngày</label>
                        <input type="date" class="form-control" id="chart-start-date">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Đến ngày</label>
                        <input type="date" class="form-control" id="chart-end-date">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="updateChartsWithCustomRange()">
                            <i class="fas fa-sync me-2"></i>Cập nhật
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6><i class="fas fa-water me-2"></i>Sản lượng tổng các giếng khoan theo ngày</h6>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-cog"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="showWellDetails()">Chi tiết từng giếng</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportChartData('wells')">Xuất dữ liệu</a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body" style="height: 300px;">
                <canvas id="wellProductionChart"></canvas>
                <small class="text-muted">Đơn vị: m³/ngày. Hiển thị tổng sản lượng 5 giếng hoạt động (GK1, GK2, GK3, GK5, GK5-TT)</small>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6><i class="fas fa-tint me-2"></i>Sản lượng nhà máy nước sạch theo ngày</h6>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-cog"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="showCleanWaterDetails()">Chi tiết hóa chất</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportChartData('clean-water')">Xuất dữ liệu</a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body" style="height: 300px;">
                <canvas id="cleanWaterChart"></canvas>
                <small class="text-muted">Đơn vị: m³/ngày. Bao gồm nước từ giếng khoan + nước thô Jasan</small>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6><i class="fas fa-recycle me-2"></i>Lưu lượng nước thải qua nhà máy xử lý</h6>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-cog"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="toggleWastewaterPlant(1)">Chỉ NMNT1</a></li>
                        <li><a class="dropdown-item" href="#" onclick="toggleWastewaterPlant(2)">Chỉ NMNT2</a></li>
                        <li><a class="dropdown-item" href="#" onclick="toggleWastewaterPlant('both')">Cả hai nhà máy</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="exportChartData('wastewater')">Xuất dữ liệu</a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body" style="height: 300px;">
                <canvas id="wastewaterChart"></canvas>
                <small class="text-muted">Đơn vị: m³/ngày. NMNT1: 12,000 m³/ngày, NMNT2: 8,000 m³/ngày</small>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6><i class="fas fa-users me-2"></i>Tiêu thụ nước của khách hàng</h6>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-cog"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="showTopCustomers()">Top 10 khách hàng</a></li>
                        <li><a class="dropdown-item" href="#" onclick="showCustomerTrends()">Xu hướng tiêu thụ</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="exportChartData('customers')">Xuất dữ liệu</a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body" style="height: 300px;">
                <canvas id="customerChart"></canvas>
                <small class="text-muted">Tổng tiêu thụ 50 khách hàng. Nước thải tính theo tỷ lệ hoặc đồng hồ trực tiếp</small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Quick Actions -->
{% if current_user.role.value in ['data_entry', 'plant_manager', 'admin'] %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-tasks me-2"></i>Thao tác nhanh</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <a href="{{ url_for('data_entry') }}" class="btn btn-outline-primary w-100">
                            <i class="fas fa-edit me-2"></i>Nhập liệu hôm nay
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('data_entry') }}#wells" class="btn btn-outline-info w-100">
                            <i class="fas fa-water me-2"></i>Sản lượng giếng
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('data_entry') }}#customers" class="btn btn-outline-warning w-100">
                            <i class="fas fa-users me-2"></i>Chỉ số khách hàng
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('reports') }}" class="btn btn-outline-success w-100">
                            <i class="fas fa-file-alt me-2"></i>Tạo báo cáo
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadKPIData();
    loadSystemDiagram();
    
    {% if current_user.role.value in ['leadership', 'plant_manager', 'admin'] %}
    loadDashboardCharts();
    {% endif %}
});
</script>
{% endblock %}
