{% extends "base.html" %}

{% block title %}Nhập liệu - Hệ thống quản lý nước Phố Nối{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-edit text-primary me-2"></i>Nhập liệu sản xuất</h1>
        <p class="text-muted">Nhập dữ liệu sản xuất và vận hành hàng ngày</p>
    </div>
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="dataEntryTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="wells-tab" data-bs-toggle="tab" data-bs-target="#wells" type="button" role="tab">
            <i class="fas fa-water me-2"></i>Giếng khoan
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="clean-water-tab" data-bs-toggle="tab" data-bs-target="#clean-water" type="button" role="tab">
            <i class="fas fa-tint me-2"></i>Nhà máy nước sạch
        </button>
    </li>
        <li class="nav-item" role="presentation">
        <button class="nav-link" id="tanks-tab" data-bs-toggle="tab" data-bs-target="#tanks" type="button" role="tab">
            <i class="fas fa-layer-group me-2"></i>Bể chứa
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="wastewater-tab" data-bs-toggle="tab" data-bs-target="#wastewater" type="button" role="tab">
            <i class="fas fa-recycle me-2"></i>Nhà máy nước thải
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="customers-tab" data-bs-toggle="tab" data-bs-target="#customers" type="button" role="tab">
            <i class="fas fa-users me-2"></i>Khách hàng
        </button>
    </li>
</ul>

<div class="tab-content" id="dataEntryTabsContent">
    <!-- Wells Tab -->
    <div class="tab-pane fade show active" id="wells" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-water me-2"></i>Sản lượng giếng khoan</h5>
            </div>
            <div class="card-body">
                <form id="wellForm" action="{{ url_for('submit_well_data') }}" method="post">
                    <input type="hidden" name="return_to" value="wells">
                    <input type="hidden" name="overwrite_ids" id="overwrite-ids" value="">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="well-date" class="form-label">Ngày</label>
                            <input type="date" class="form-control" id="well-date" name="date" value="{{ date.today() }}" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        {% for well in wells %}
                        <div class="col-md-6 mb-3">
                            <div class="card {% if well.is_backup %}border-warning{% endif %}">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        {{ well.name }} ({{ well.code }})
                                        {% if well.is_backup %}
                                        <span class="badge bg-warning">Dự phòng</span>
                                        {% endif %}
                                    </h6>
                                    <div class="mb-2">
                                        <label class="form-label">Lượng nước khai thác (m³)</label>
                                        <input type="number" class="form-control" name="production_{{ well.id }}" 
                                               step="0.1" min="0" {% if well.is_backup %}value="0" readonly{% endif %}>
                                        <input type="hidden" name="well_ids" value="{{ well.id }}">
                                    </div>
                                    <small class="text-muted">Công suất: {{ well.capacity }} m³/ngày</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Lưu dữ liệu giếng
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Clean Water Plant Tab -->
    <div class="tab-pane fade" id="clean-water" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tint me-2"></i>Nhà máy xử lý nước sạch</h5>
            </div>
            <div class="card-body">
                <form id="cleanWaterForm" action="{{ url_for('submit_clean_water_plant') }}" method="post">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="clean-water-date" class="form-label">Ngày</label>
                            <input type="date" class="form-control" id="clean-water-date" name="date" value="{{ date.today() }}" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6>Tiêu hao điện và hóa chất</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Điện tiêu thụ (kWh)</label>
                                        <input type="number" class="form-control" name="electricity" step="0.1" min="0">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">PAC (kg)</label>
                                        <input type="number" class="form-control" name="pac_usage" step="0.1" min="0">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Xút (kg)</label>
                                        <input type="number" class="form-control" name="naoh_usage" step="0.1" min="0">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Polymer (kg)</label>
                                        <input type="number" class="form-control" name="polymer_usage" step="0.1" min="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6>Sản lượng nước</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label text-muted">Nước sạch sản xuất (m³)</label>
                                        <input type="number" class="form-control" name="clean_water_output" step="0.1" min="0" disabled style="opacity: 0.5; background-color: #f8f9fa;">
                                        <small class="text-muted">Hệ thống tự tính toán</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Nước thô Jasan (m³)</label>
                                        <input type="number" class="form-control" name="raw_water_jasan" step="0.1" min="0">
                                        <small class="text-muted">Nước mua từ bên ngoài</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- <input type="hidden" name="overwrite" id="overwrite-flag" value="0" /> -->
                    <input type="hidden" name="return_to" value="clean-water" />

                    <div class="text-end mt-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Lưu dữ liệu nhà máy nước sạch
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Wastewater Plant Tab -->
    <div class="tab-pane fade" id="wastewater" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-recycle me-2"></i>Nhà máy nước thải số 1</h5>
                        <small class="text-muted">Công suất: 12,000 m³/ngày</small>
                    </div>
                    <div class="card-body">
                        <form id="wastewaterForm1" action="{{ url_for('submit_wastewater_plant') }}" method="post">
                            <input type="hidden" name="return_to" value="wastewater-1">
                            <input type="hidden" name="overwrite" id="overwrite-wastewater-1" value="0">
                            <input type="hidden" name="plant_number" value="1">
                            
                            <div class="mb-3">
                                <label class="form-label">Ngày</label>
                                <input type="date" class="form-control" name="date" value="{{ date.today() }}" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Nước thải theo đồng hồ (m³)</label>
                                <input type="number" class="form-control" name="wastewater_meter" step="0.1" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Nước thải đầu vào TQT (m³)</label>
                                <input type="number" class="form-control" name="input_flow_tqt" step="0.1" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Nước thải đầu ra TQT (m³)</label>
                                <input type="number" class="form-control" name="output_flow_tqt" step="0.1" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Bùn thải (m³)</label>
                                <input type="number" class="form-control" name="sludge_output" step="0.1" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Điện tiêu thụ (kWh)</label>
                                <input type="number" class="form-control" name="electricity" step="0.1" min="0">
                            </div>
                            
                            <!-- <input type="hidden" name="chemical_usage" value="0"> -->
                            <div class="mb-3">
                                <label class="form-label">Hóa chất sử dụng (kg)</label>
                                <input type="number" class="form-control" name="chemical_usage" step="0.1" min="0">
                            </div>
                            
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Lưu NMNT1
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-recycle me-2"></i>Nhà máy nước thải số 2</h5>
                        <small class="text-muted">Công suất: 8,000 m³/ngày</small>
                    </div>
                    <div class="card-body">
                        <form id="wastewaterForm2" action="{{ url_for('submit_wastewater_plant') }}" method="post">
                            <input type="hidden" name="return_to" value="wastewater-2">
                            <input type="hidden" name="overwrite" id="overwrite-wastewater-2" value="0">
                            <input type="hidden" name="plant_number" value="2">
                            
                            <div class="mb-3">
                                <label class="form-label">Ngày</label>
                                <input type="date" class="form-control" name="date" value="{{ date.today() }}" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Nước thải theo đồng hồ (m³)</label>
                                <input type="number" class="form-control" name="wastewater_meter" step="0.1" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Nước thải đầu vào TQT (m³)</label>
                                <input type="number" class="form-control" name="input_flow_tqt" step="0.1" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Nước thải đầu ra TQT (m³)</label>
                                <input type="number" class="form-control" name="output_flow_tqt" step="0.1" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Bùn thải (m³)</label>
                                <input type="number" class="form-control" name="sludge_output" step="0.1" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Điện tiêu thụ (kWh)</label>
                                <input type="number" class="form-control" name="electricity" step="0.1" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Hóa chất sử dụng (kg)</label>
                                <input type="number" class="form-control" name="chemical_usage" step="0.1" min="0">
                            </div>
                            
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Lưu NMNT2
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Customers Tab -->
    <div class="tab-pane fade" id="customers" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-users me-2"></i>Chỉ số khách hàng</h5>
                <small class="text-muted">Chốt số từ ngày 25 tháng trước đến 25 tháng sau</small>
            </div>
            <div class="card-body">
                <form method="POST" id="customerForm" action="{{ url_for('submit_customer_readings') }}">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="customer-date" class="form-label">Ngày chốt</label>
                            <input type="date" class="form-control" id="customer-date" name="date" value="{{ date.today() }}" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Tìm kiếm khách hàng</label>
                            <input type="text" class="form-control" id="customer-search" placeholder="Tên công ty...">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Lọc theo loại</label>
                            <select class="form-select" id="customer-filter">
                                <option value="">Tất cả</option>
                                <option value="daily">Đọc số hàng ngày</option>
                                <option value="monthly">Đọc số hàng tháng</option>
                            </select>
                        </div>
                    </div>
                    
                    <input type="hidden" name="overwrite_customer_ids" id="overwrite-customer-ids" value="">
                    
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Khách hàng</th>
                                    <th>Loại</th>
                                    <th>Tỷ lệ NT/NS</th>
                                    <th>Chỉ số nước sạch (m³)</th>
                                    <th>Chỉ số nước thải (m³)</th>
                                </tr>
                            </thead>
                            <tbody id="customer-table-body">
                                {% for customer in customers %}
                                <tr class="customer-row" data-daily="{{ customer.daily_reading|lower }}">
                                    <td>
                                        <strong>{{ customer.company_name }}</strong><br>
                                        <small class="text-muted">{{ customer.contact_person }}</small>
                                        <input type="hidden" name="customer_ids" value="{{ customer.id }}">
                                    </td>
                                    <td>
                                        {% if customer.daily_reading %}
                                        <span class="badge bg-warning">Hàng ngày</span>
                                        {% else %}
                                        <span class="badge bg-info">Hàng tháng</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ "%.2f"|format(customer.water_ratio) }}</td>
                                    <td>
                                        <input type="number" class="form-control" name="clean_water_{{ customer.id }}" 
                                               step="0.1" min="0" placeholder="Chỉ số NS">
                                    </td>
                                    <td>
                                        {% if customer.daily_reading %}
                                        <input type="number" class="form-control" name="wastewater_{{ customer.id }}" 
                                               step="0.1" min="0" placeholder="Chỉ số NT (tùy chọn)">
                                        <small class="text-muted">Để trống sẽ tự tính</small>
                                        {% else %}
                                        <input type="text" class="form-control" value="Tự động tính: {{ "%.2f"|format(customer.water_ratio) }}x NS" readonly>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="text-end mt-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Lưu chỉ số khách hàng
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Water Tanks Tab -->
    <div class="tab-pane fade" id="tanks" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-layer-group me-2"></i>Mức nước bể chứa</h5>
                <small class="text-muted">Nhập mức nước hiện tại của các bể chứa</small>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('submit_tank_levels') }}">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="tank-date" class="form-label">Ngày</label>
                            <input type="date" class="form-control" id="tank-date" name="date" value="{{ date.today() }}" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        {% for tank in tanks %}
                        <div class="col-md-4 mb-3">
                            <div class="card {% if tank.tank_type == 'clean_water' %}border-success{% else %}border-info{% endif %}">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        {{ tank.name }}
                                        {% if tank.tank_type == 'clean_water' %}
                                        <span class="badge bg-success">Nước sạch</span>
                                        {% else %}
                                        <span class="badge bg-info">Nước thô</span>
                                        {% endif %}
                                    </h6>
                                    <div class="mb-2">
                                        <label class="form-label">Mức nước hiện tại (m³)</label>
                                        <input type="number" class="form-control" name="level_{{ tank.id }}" 
                                               step="0.1" min="0" max="{{ tank.capacity }}" 
                                               placeholder="0 - {{ tank.capacity }}">
                                        <input type="hidden" name="tank_ids" value="{{ tank.id }}">
                                    </div>
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" style="width: 0%" 
                                             data-tank-id="{{ tank.id }}" data-capacity="{{ tank.capacity }}">0%</div>
                                    </div>
                                    <small class="text-muted">
                                        Dung tích tối đa: {{ tank.capacity|round|int }} m³
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Lưu mức nước bể chứa
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Tắt auto scroll restore của trình duyệt
  if ('scrollRestoration' in history) history.scrollRestoration = 'manual';

  const tabsSelector = '#dataEntryTabs button[data-bs-toggle="tab"]';

  // Hàm ép về đầu trang ở nhiều “nhịp” để thắng mọi restore/autofocus
  const forceToTop = () => {
    window.scrollTo(0, 0);                         // ngay lập tức
    requestAnimationFrame(() => window.scrollTo(0, 0)); // sau frame
    setTimeout(() => window.scrollTo(0, 0), 0);    // macrotask tiếp theo (Safari)
  };

  // 1) Gắn listener TRƯỚC khi show tab (để reload cũng scroll-top sau khi tab hiển thị)
  document.querySelectorAll(tabsSelector).forEach(btn => {
    btn.addEventListener('shown.bs.tab', e => {
      const target = e.target.getAttribute('data-bs-target');
      if (target) sessionStorage.setItem('dataEntryActiveTab', target);
      forceToTop();
    });
  });

  // 2) Khôi phục tab đã lưu (không dùng hash)
  const savedTab = sessionStorage.getItem('dataEntryActiveTab');
  if (savedTab) {
    const trigger = document.querySelector(`${tabsSelector}[data-bs-target="${savedTab}"]`);
    if (trigger && window.bootstrap) new bootstrap.Tab(trigger).show();
  }

  // 3) Luôn về đầu trang khi mới load và khi trang được phục hồi từ BFCache
  forceToTop();
  window.addEventListener('load', () => forceToTop(), { once: true });
  window.addEventListener('pageshow', (e) => {
    if (e.persisted) forceToTop(); // Safari/Firefox BFCache
  });

  // 4) Trước khi submit form, nhớ tab đang mở
  document.querySelectorAll('#dataEntryTabsContent form').forEach(form => {
    form.addEventListener('submit', () => {
      const activeBtn = document.querySelector('#dataEntryTabs .nav-link.active');
      const target = activeBtn ? activeBtn.getAttribute('data-bs-target') : null;
      if (target) sessionStorage.setItem('dataEntryActiveTab', target);
    });
  });
});

/* --- Tab Nhà máy nước sạch --- */
document.addEventListener('DOMContentLoaded', function () {
  const cleanForm = document.getElementById('cleanWaterForm');
  if (!cleanForm) return;

  cleanForm.addEventListener('submit', async function (e) {
    e.preventDefault();
    const dateVal = (cleanForm.querySelector('input[name="date"]') || {}).value;

    // Các field cần kiểm tra
    const fieldNames = ['electricity','pac_usage','naoh_usage','polymer_usage','clean_water_output','raw_water_jasan'];
    const labels = {
      electricity: 'Điện tiêu thụ (kWh)',
      pac_usage: 'PAC (kg)',
      naoh_usage: 'Xút (kg)',
      polymer_usage: 'Polymer (kg)',
      clean_water_output: 'Nước sạch sản xuất (m³)',
      raw_water_jasan: 'Nước thô Jasan (m³)'
    };

    // Chỉ liệt kê các ô đã nhập (kể cả "0")
    const filled = fieldNames.map(n => {
      const el = cleanForm.querySelector(`[name="${n}"]`);
      const v = el ? (el.value || '').trim() : '';
      return v === '' ? null : `- ${labels[n] || n}: ${v}`;
    }).filter(Boolean);

    if (!dateVal || filled.length === 0) { cleanForm.submit(); return; }

    try {
      // Gọi API kiểm tra tồn tại theo ngày
      const url = `{{ url_for('clean_water_plant_exists') }}?date=${encodeURIComponent(dateVal)}`;
      const res = await fetch(url, { credentials: 'same-origin' });
      const data = await res.json();

      if (data.exists) {
        const ok = window.confirm(
          `Đã có dữ liệu ngày ${dateVal} cho Nhà máy nước sạch.\n` +
          `Bạn sắp ghi đè các trường sau:\n${filled.join('\n')}\n\nTiếp tục?`
        );
        if (!ok) return;
        // Set cờ ghi đè để backend cho phép cập nhật
        const ow = document.getElementById('overwrite-flag') || cleanForm.querySelector('input[name="overwrite"]');
        if (ow) ow.value = '1';
      }
    } catch (_) { /* ignore lỗi mạng, vẫn submit */ }

    cleanForm.submit();
  });
});

/* Helpers chung */
function getFilledNumericFields(form, names, labelsMap) {
  // Trả danh sách {name, label, value} với các input có nhập (kể cả "0")
  const out = [];
  for (const n of names) {
    const el = form.querySelector(`[name="${n}"]`);
    if (!el) continue;
    const raw = (el.value || '').trim();
    if (raw === '') continue;
    out.push({ name: n, label: labelsMap[n] || n, value: raw });
  }
  return out;
}

/* --- Tab Giếng khoan --- */
document.addEventListener('DOMContentLoaded', function () {
  const wellForm = document.getElementById('wellForm');
  if (wellForm) {
    wellForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      const dateVal = (wellForm.querySelector('input[name="date"]') || {}).value;
      const allIds = Array.from(wellForm.querySelectorAll('input[name="well_ids"]')).map(i => i.value);

      // Lọc các giếng đã nhập (kể cả "0")
      const filled = allIds
        .map(id => {
          const el = wellForm.querySelector(`input[name="production_${id}"]`);
          const raw = el ? (el.value || '').trim() : '';
          return raw === '' ? null : { id: Number(id), value: raw };
        })
        .filter(Boolean);

      if (!dateVal || filled.length === 0) {
        wellForm.submit(); return;
      }

      // Gọi API kiểm tra chỉ với các giếng đã nhập
      const idsParam = filled.map(f => f.id).join(',');
      try {
        const url = `{{ url_for('well_production_exists') }}?date=${encodeURIComponent(dateVal)}&well_ids=${encodeURIComponent(idsParam)}`;
        const res = await fetch(url, { credentials: 'same-origin' });
        const data = await res.json();

        if (data.exists && Array.isArray(data.wells) && data.wells.length) {
          // Lấy danh sách giếng đã nhập và đã có dữ liệu -> sẽ ghi đè
          const existingSet = new Set(data.wells.map(Number));
          const toOverwrite = filled.filter(f => existingSet.has(f.id));
          if (toOverwrite.length) {
            const lines = toOverwrite.map(f => `- Giếng ${f.id}: ${f.value} m³`).join('\n');
            const ok = window.confirm(
              `Đã có dữ liệu ngày ${dateVal} cho một số giếng.\n` +
              `Bạn sắp ghi đè các giếng sau:\n${lines}\n\nTiếp tục?`
            );
            if (!ok) return;
            // Gửi danh sách giếng cần ghi đè
            document.getElementById('overwrite-ids').value = toOverwrite.map(f => f.id).join(',');
          }
        }
      } catch (_) { /* bỏ qua lỗi mạng, vẫn submit */ }

      wellForm.submit();
    });
  }
});

/* --- Tab Nước thải (NMNT 1/2) --- */
function hasAnyValue(form, names) {
  return names.some(n => {
    const el = form.querySelector(`[name="${n}"]`);
    const v = el ? (el.value || '').trim() : '';
    return v !== '';
  });
}

async function attachWastewaterFormHandler(formId, overwriteId, plantNumber) {
  const form = document.getElementById(formId);
  if (!form) return;

  // Map tên input -> nhãn hiển thị
  const numericFields = ['wastewater_meter','input_flow_tqt','output_flow_tqt','sludge_output','electricity','chemical_usage'];
  const labelsMap = {
    wastewater_meter: 'Đồng hồ nước thải',
    input_flow_tqt: 'Lưu lượng đầu vào TQT',
    output_flow_tqt: 'Lưu lượng đầu ra TQT',
    sludge_output: 'Bùn thải',
    electricity: 'Điện năng',
    chemical_usage: 'Hóa chất'
  };

  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    const dateVal = (form.querySelector('input[name="date"]') || {}).value;

    // Chỉ kiểm tra khi có nhập ít nhất một trường
    const filled = getFilledNumericFields(form, numericFields, labelsMap);
    if (!dateVal || filled.length === 0) {
      form.submit(); return;
    }

    try {
      const url = `{{ url_for('wastewater_plant_exists') }}?date=${encodeURIComponent(dateVal)}&plant_numbers=${plantNumber}`;
      const res = await fetch(url, { credentials: 'same-origin' });
      const data = await res.json();

      if (data.exists && Array.isArray(data.plants) && data.plants.includes(plantNumber)) {
        const lines = filled.map(f => `- ${f.label}: ${f.value}`).join('\n');
        const ok = window.confirm(
          `Đã có dữ liệu ngày ${dateVal} cho Nhà máy nước thải ${plantNumber}.\n` +
          `Bạn sắp ghi đè các trường sau:\n${lines}\n\nTiếp tục?`
        );
        if (!ok) return;
        document.getElementById(overwriteId).value = '1';
      }
    } catch (_) { /* ignore mạng */ }

    form.submit();
  });
}

document.addEventListener('DOMContentLoaded', function () {
  attachWastewaterFormHandler('wastewaterForm1', 'overwrite-wastewater-1', 1);
  attachWastewaterFormHandler('wastewaterForm2', 'overwrite-wastewater-2', 2);
});

/* --- Tab Khách hàng --- */
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('customerForm');
  if (!form) return;

    // Filtering: search by company/contact + filter by type (daily/monthly)
    const searchEl = document.getElementById('customer-search');
    const filterEl = document.getElementById('customer-filter');
    const tbodySelector = '#customer-table-body .customer-row';

    function applyCustomerFilters() {
        const term = (searchEl && searchEl.value ? searchEl.value.toLowerCase().trim() : '');
        const type = (filterEl && filterEl.value) || '';
        const rows = document.querySelectorAll(tbodySelector);
        rows.forEach(row => {
            const dailyRaw = (row.dataset.daily || '').toLowerCase();
            const isDaily = (dailyRaw === 'true' || dailyRaw === '1');
            const matchesType = !type || (type === 'daily' ? isDaily : !isDaily);
            const text0 = (row.cells && row.cells[0] ? row.cells[0].textContent.toLowerCase() : '');
            const matchesSearch = !term || text0.includes(term);
            row.style.display = (matchesType && matchesSearch) ? '' : 'none';
        });
    }

    if (searchEl) searchEl.addEventListener('input', applyCustomerFilters);
    if (filterEl) filterEl.addEventListener('change', applyCustomerFilters);
    // Initial run
    applyCustomerFilters();

  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    const dateVal = (form.querySelector('input[name="date"]') || {}).value;

    const ids = Array.from(form.querySelectorAll('input[name="customer_ids"]'))
      .map(i => Number(i.value)).filter(Boolean);

    const filled = ids.map(id => {
      const cw = (form.querySelector(`input[name="clean_water_${id}"]`)?.value || '').trim();
      const ww = (form.querySelector(`input[name="wastewater_${id}"]`)?.value || '').trim();
      return (cw !== '' || ww !== '') ? { id, cw, ww } : null;
    }).filter(Boolean);

    if (!dateVal || filled.length === 0) { form.submit(); return; }

    try {
      const url = `{{ url_for('data_entry.customer_readings_exists') }}?date=${encodeURIComponent(dateVal)}&customer_ids=${encodeURIComponent(filled.map(x=>x.id).join(','))}`;
      const res = await fetch(url, { credentials: 'same-origin' });
      const data = await res.json();

      if (data.exists && Array.isArray(data.customers) && data.customers.length) {
        const existSet = new Set(data.customers.map(Number));
        const toOverwrite = filled.filter(f => existSet.has(f.id));
        if (toOverwrite.length) {
          const lines = toOverwrite.map(it => {
            const parts = [];
            if (it.cw !== '') parts.push(`- Nước sạch: ${it.cw}`);
            if (it.ww !== '') parts.push(`- Nước thải: ${it.ww}`);
            return `KH ${it.id}:\n${parts.join('\n')}`;
          }).join('\n');
          const ok = window.confirm(
            `Đã có dữ liệu ngày ${dateVal} cho một số khách hàng.\n` +
            `Bạn sắp ghi đè dữ liệu cho các khách hàng sau:\n\n${lines}\n\nTiếp tục?`
          );
          if (!ok) return;
          document.getElementById('overwrite-customer-ids').value = toOverwrite.map(x => x.id).join(',');
        }
      }
    } catch (_) { /* ignore */ }

    form.submit();
  });
});
</script>
{% endblock %}
