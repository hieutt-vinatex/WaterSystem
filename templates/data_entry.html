{% extends "base.html" %}

{% block title %}Nhập liệu - Hệ thống quản lý nước Phố Nối{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-edit text-primary me-2"></i>Nhập liệu sản xuất</h1>
        <p class="text-muted">Nhập dữ liệu sản xuất và vận hành hàng ngày</p>
    </div>
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="dataEntryTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="wells-tab" data-bs-toggle="tab" data-bs-target="#wells" type="button" role="tab">
            <i class="fas fa-water me-2"></i>Giếng khoan
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="clean-water-tab" data-bs-toggle="tab" data-bs-target="#clean-water" type="button" role="tab">
            <i class="fas fa-tint me-2"></i>Nhà máy nước sạch
        </button>
    </li>
        <li class="nav-item" role="presentation">
        <button class="nav-link" id="tanks-tab" data-bs-toggle="tab" data-bs-target="#tanks" type="button" role="tab">
            <i class="fas fa-layer-group me-2"></i>Bể chứa
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="wastewater-tab" data-bs-toggle="tab" data-bs-target="#wastewater" type="button" role="tab">
            <i class="fas fa-recycle me-2"></i>Nhà máy nước thải
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="customers-tab" data-bs-toggle="tab" data-bs-target="#customers" type="button" role="tab">
            <i class="fas fa-users me-2"></i>Khách hàng
        </button>
    </li>
</ul>

<div class="tab-content" id="dataEntryTabsContent">
    <!-- Wells Tab -->
    <div class="tab-pane fade show active" id="wells" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-water me-2"></i>Sản lượng giếng khoan</h5>
            </div>
            <div class="card-body">
                <form id="wellForm" action="{{ url_for('submit_well_data') }}" method="post">
                    <input type="hidden" name="return_to" value="wells">
                    <input type="hidden" name="overwrite_ids" id="overwrite-ids" value="">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="well-date" class="form-label">Ngày</label>
                            <input type="date" class="form-control" id="well-date" name="date" value="{{ date.today() }}" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        {% for well in wells %}
                        <div class="col-md-6 mb-3">
                            <div class="card {% if well.is_backup %}border-warning{% endif %}">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        {{ well.name }} ({{ well.code }})
                                        {% if well.is_backup %}
                                        <span class="badge bg-warning">Dự phòng</span>
                                        {% endif %}
                                    </h6>
                                    <div class="mb-2">
                                        <label class="form-label">Chỉ số đồng hồ (m³)</label>
                                        <input type="number" class="form-control" name="production_{{ well.id }}" 
                                            step="0.1" min="0" {% if well.is_backup %}value="0" readonly{% endif %}>
                                        <input type="hidden" name="well_ids" value="{{ well.id }}">
                                    </div>
                                    <!-- <small class="text-muted">Công suất: {{ well.capacity }} m³/ngày</small> -->
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Lưu dữ liệu giếng
                        </button>
                    </div>
                    <div class="card mt-4">
                        <div class="card-header d-flex flex-wrap gap-2 align-items-center justify-content-between">
                            <h5 class="mb-0"><i class="fas fa-table me-2"></i>Lịch sử nhập liệu</h5>
                            <div class="d-flex flex-wrap gap-2 align-items-center">
                            <select id="wells-range" class="form-select form-select-sm" style="width:auto;">
                                <option value="30" selected>30 ngày gần nhất</option>
                                <option value="60">60 ngày gần nhất</option>
                                <option value="90">90 ngày gần nhất</option>
                            </select>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                            <table class="table table-sm table-striped mb-0">
                                <thead class="table-light">
                                <tr id="wells-head"><th>Ngày</th></tr>
                                </thead>
                                <tbody id="wells-body">
                                <tr><td class="text-center py-3">Đang tải...</td></tr>
                                </tbody>
                            </table>
                            </div>
                        </div>
                        <div class="card-footer d-flex justify-content-between align-items-center">
                            <small id="wells-summary" class="text-muted">—</small>
                            <nav><ul id="wells-pagination" class="pagination pagination-sm mb-0"></ul></nav>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Clean Water Plant Tab -->
    <div class="tab-pane fade" id="clean-water" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tint me-2"></i>Nhà máy xử lý nước sạch</h5>
            </div>
            <div class="card-body">
                <form id="cleanWaterForm" action="{{ url_for('submit_clean_water_plant') }}" method="post">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="clean-water-date" class="form-label">Ngày</label>
                            <input type="date" class="form-control" id="clean-water-date" name="date" value="{{ date.today() }}" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6>Tiêu hao điện và hóa chất</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Điện tiêu thụ (kWh)</label>
                                        <input type="number" class="form-control" name="electricity" step="0.1" min="0">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">PAC (kg)</label>
                                        <input type="number" class="form-control" name="pac_usage" step="0.1" min="0">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Xút (kg)</label>
                                        <input type="number" class="form-control" name="naoh_usage" step="0.1" min="0">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Polymer (kg)</label>
                                        <input type="number" class="form-control" name="polymer_usage" step="0.1" min="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6>Sản lượng nước</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label text-muted">Nước sạch sản xuất (m³)</label>
                                        <input type="number" class="form-control" name="clean_water_output" step="0.1" min="0" disabled style="opacity: 0.5; background-color: #f8f9fa;">
                                        <small class="text-muted">Hệ thống tự tính toán</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Nước thô cấp cho Jasan (m³)</label>
                                        <input type="number" class="form-control" name="raw_water_jasan" step="0.1" min="0">
                                        <!-- <small class="text-muted">Nước mua từ bên ngoài</small> -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- <input type="hidden" name="overwrite" id="overwrite-flag" value="0" /> -->
                    <input type="hidden" name="return_to" value="clean-water" />

                    <div class="text-end mt-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Lưu dữ liệu nhà máy nước sạch
                        </button>
                    </div>
                    <div class="card mt-4">
                        <div class="card-header d-flex flex-wrap gap-2 align-items-center justify-content-between">
                            <h6 class="mb-0"><i class="fas fa-table me-2"></i>Lịch sử theo ngày</h6>
                            <select id="cw-range" class="form-select form-select-sm" style="width:auto;">
                            <option value="30" selected>30 ngày gần nhất</option>
                            <option value="60">60 ngày gần nhất</option>
                            <option value="90">90 ngày gần nhất</option>
                            </select>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                            <table class="table table-sm table-striped mb-0">
                                <thead class="table-light">
                                <tr id="cw-head">
                                    <th>Ngày</th>
                                    <th>Điện tiêu thụ (kWh)</th>
                                    <th>PAC (kg)</th>
                                    <th>Xút (kg)</th>
                                    <th>Polymer (kg)</th>
                                    <th>Nước sạch sản xuất (m³)</th>
                                    <th>Nước thô cấp cho Jasan (m³)</th>
                                </tr>
                                </thead>
                                <tbody id="cw-body">
                                <tr><td class="text-center py-3" colspan="7">Đang tải...</td></tr>
                                </tbody>
                            </table>
                            </div>
                        </div>
                        <div class="card-footer d-flex justify-content-between align-items-center">
                            <small id="cw-summary" class="text-muted">—</small>
                            <nav><ul id="cw-pagination" class="pagination pagination-sm mb-0"></ul></nav>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Wastewater Plant Tab -->
    <div class="tab-pane fade" id="wastewater" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-recycle me-2"></i>Nhà máy nước thải số 1</h5>
                        <small class="text-muted">Công suất: 12,000 m³/ngày</small>
                    </div>
                    <div class="card-body">
                        <form id="wastewaterForm1" action="{{ url_for('submit_wastewater_plant') }}" method="post">
                            <input type="hidden" name="return_to" value="wastewater-1">
                            <input type="hidden" name="overwrite" id="overwrite-wastewater-1" value="0">
                            <input type="hidden" name="plant_number" value="1">
                            
                            <div class="mb-3">
                                <label class="form-label">Ngày</label>
                                <input type="date" class="form-control" name="date" value="{{ date.today() }}" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Nước thải theo đồng hồ (m³)</label>
                                <input type="number" class="form-control" name="wastewater_meter" step="0.1" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Nước thải đầu vào TQT (m³)</label>
                                <input type="number" class="form-control" name="input_flow_tqt" step="0.1" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Nước thải đầu ra TQT (m³)</label>
                                <input type="number" class="form-control" name="output_flow_tqt" step="0.1" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Bùn thải (m³)</label>
                                <input type="number" class="form-control" name="sludge_output" step="0.1" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Điện tiêu thụ (kWh)</label>
                                <input type="number" class="form-control" name="electricity" step="0.1" min="0">
                            </div>
                            
                            <!-- <input type="hidden" name="chemical_usage" value="0"> -->
                            <div class="mb-3">
                                <label class="form-label">Hóa chất sử dụng (kg)</label>
                                <input type="number" class="form-control" name="chemical_usage" step="0.1" min="0">
                            </div>
                            
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Lưu NMNT1
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-recycle me-2"></i>Nhà máy nước thải số 2</h5>
                        <small class="text-muted">Công suất: 8,000 m³/ngày</small>
                    </div>
                    <div class="card-body">
                        <form id="wastewaterForm2" action="{{ url_for('submit_wastewater_plant') }}" method="post">
                            <input type="hidden" name="return_to" value="wastewater-2">
                            <input type="hidden" name="overwrite" id="overwrite-wastewater-2" value="0">
                            <input type="hidden" name="plant_number" value="2">
                            
                            <div class="mb-3">
                                <label class="form-label">Ngày</label>
                                <input type="date" class="form-control" name="date" value="{{ date.today() }}" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Nước thải theo đồng hồ (m³)</label>
                                <input type="number" class="form-control" name="wastewater_meter" step="0.1" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Nước thải đầu vào TQT (m³)</label>
                                <input type="number" class="form-control" name="input_flow_tqt" step="0.1" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Nước thải đầu ra TQT (m³)</label>
                                <input type="number" class="form-control" name="output_flow_tqt" step="0.1" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Bùn thải (m³)</label>
                                <input type="number" class="form-control" name="sludge_output" step="0.1" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Điện tiêu thụ (kWh)</label>
                                <input type="number" class="form-control" name="electricity" step="0.1" min="0">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Hóa chất sử dụng (kg)</label>
                                <input type="number" class="form-control" name="chemical_usage" step="0.1" min="0">
                            </div>
                            
                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Lưu NMNT2
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
            </div>
        </div>
        <div class="card mt-4">
                    <div class="card-header d-flex flex-wrap gap-2 align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-2">
                        <h6 class="mb-0"><i class="fas fa-table me-2"></i>Lịch sử nước thải theo ngày</h6>
                        <div class="form-check ms-2">
                            <input class="form-check-input" type="checkbox" id="ww-aggregate">
                            <label class="form-check-label" for="ww-aggregate">Gộp tổng</label>
                        </div>
                        <div class="form-check ms-2">
                            <input class="form-check-input" type="checkbox" id="ww-extra">
                            <label class="form-check-label" for="ww-extra">Hiện chi tiết</label>
                        </div>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                        <div class="btn-group" role="group" aria-label="Chọn NMNT">
                            <input type="checkbox" class="btn-check" id="ww-p1" autocomplete="off" checked>
                            <label class="btn btn-outline-secondary btn-sm" for="ww-p1">NMNT1</label>
                            <input type="checkbox" class="btn-check" id="ww-p2" autocomplete="off" checked>
                            <label class="btn btn-outline-secondary btn-sm" for="ww-p2">NMNT2</label>
                        </div>
                        <select id="ww-range" class="form-select form-select-sm" style="width:auto;">
                            <option value="30" selected>30 ngày gần nhất</option>
                            <option value="60">60 ngày gần nhất</option>
                            <option value="90">90 ngày gần nhất</option>
                        </select>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                        <table class="table table-sm table-striped mb-0">
                            <thead class="table-light">
                            <tr id="ww-head"><th>Ngày</th></tr>
                            </thead>
                            <tbody id="ww-body">
                            <tr><td class="text-center py-3" colspan="999">Đang tải...</td></tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <small id="ww-summary" class="text-muted">—</small>
                        <nav><ul id="ww-pagination" class="pagination pagination-sm mb-0"></ul></nav>
                    </div>
                </div>
    </div>
    
    <!-- Customers Tab -->
    <div class="tab-pane fade" id="customers" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-users me-2"></i>Chỉ số khách hàng</h5>
                <small class="text-muted">Chốt số từ ngày 25 tháng trước đến 25 tháng sau</small>
            </div>
            <div class="card-body">
                <form method="POST" id="customerForm" action="{{ url_for('submit_customer_readings') }}">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="customer-date" class="form-label">Ngày chốt</label>
                            <input type="date" class="form-control" id="customer-date" name="date" value="{{ date.today() }}" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Tìm kiếm khách hàng</label>
                            <input type="text" class="form-control" id="customer-search" placeholder="Tên công ty...">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Lọc theo loại</label>
                            <select class="form-select" id="customer-filter">
                                <option value="">Tất cả</option>
                                <option value="daily">Đọc số hàng ngày</option>
                                <option value="monthly">Đọc số hàng tháng</option>
                            </select>
                        </div>
                    </div>
                    
                    <input type="hidden" name="overwrite_customer_ids" id="overwrite-customer-ids" value="">
                    
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Khách hàng</th>
                                    <th>Loại</th>
                                    <th>Tỷ lệ NT/NS</th>
                                    <th>Chỉ số nước sạch (m³)</th>
                                    <th>Chỉ số nước thải (m³)</th>
                                </tr>
                            </thead>
                            <tbody id="customer-table-body">
                                {% for customer in customers %}
                                <tr class="customer-row" data-daily="{{ customer.daily_reading|lower }}">
                                    <td>
                                        <strong>{{ customer.company_name }}</strong><br>
                                        <small class="text-muted">{{ customer.contact_person }}</small>
                                        <input type="hidden" name="customer_ids" value="{{ customer.id }}">
                                    </td>
                                    <td>
                                        {% if customer.daily_reading %}
                                        <span class="badge bg-warning">Hàng ngày</span>
                                        {% else %}
                                        <span class="badge bg-info">Hàng tháng</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ "%.2f"|format(customer.water_ratio) }}</td>
                                    <td >
                                        
                                        {% set show_outsource = customer.company_name in companies_outsource %}
                                        {% if customer.company_name in ['Cty TNHH Dệt và Nhuộm Hưng Yên'] %}
                                            <input type="number" class="form-control" name="clean_water_{{ customer.id }}" 
                                               step="0.1" min="0" placeholder="Chỉ số NS ĐH 1 (m³)">
                                            <input type="number" step="0.01"
                                                name="clean_water_2_{{ customer.id }}"
                                                class="form-control"
                                                style="margin-top: 10px;"
                                                placeholder="Chỉ số NS ĐH 2 (m³)">
                                            <input type="number" step="0.01"
                                                name="clean_water_3_{{ customer.id }}"
                                                class="form-control"
                                                style="margin-top: 10px;"
                                                placeholder="Chỉ số NS ĐH 3 (m³)">
                                        {% elif customer.company_name in ['Cty TNHH dệt may Lee Hing Việt Nam'] %}
                                            <input type="number" class="form-control" name="clean_water_{{ customer.id }}" 
                                               step="0.1" min="0" placeholder="Chỉ số NS ĐH 1 (m³)">
                                            <input type="number" step="0.01"
                                                name="clean_water_2_{{ customer.id }}"
                                                class="form-control"
                                                style="margin-top: 10px;"
                                                placeholder="Chỉ số NS ĐH 2 (m³)">
                                        {% else %}
                                            <input type="number" class="form-control" name="clean_water_{{ customer.id }}" 
                                               step="0.1" min="0" placeholder="Chỉ số NS">
                                        {% endif %}
                                        {% if show_outsource %}
                                            <input type="number"
                                                   step="0.1"
                                                   min="0"
                                                   name="clean_water_outsource_{{ customer.id }}"
                                                   class="form-control mt-2"
                                                   placeholder="Chỉ số ĐH mua ngoài (m³)">
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if customer.daily_reading %}
                                        <input type="number" class="form-control" name="wastewater_{{ customer.id }}" 
                                               step="0.1" min="0" placeholder="Chỉ số NT (tùy chọn)">
                                        <small class="text-muted">Để trống sẽ tự tính</small>
                                        {% else %}
                                        <input type="text" class="form-control" value="Tự động tính: {{ "%.2f"|format(customer.water_ratio) }} x (NS + nước mua ngoài)" readonly>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="text-end mt-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Lưu chỉ số khách hàng
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div class="card mt-4">
            <div class="card-header d-flex flex-wrap gap-2 align-items-center justify-content-between">
                <h6 class="mb-0"><i class="fas fa-table me-2"></i>Lịch sử khách hàng</h6>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                <input id="cust-search" type="text" class="form-control form-control-sm" placeholder="Tìm theo tên công ty..." style="width:220px;">
                <select id="cust-type" class="form-select form-select-sm" style="width:auto;">
                    <option value="">Tất cả</option>
                    <option value="daily">Hàng ngày</option>
                    <option value="monthly">Hàng tháng</option>
                </select>
                <select id="cust-range" class="form-select form-select-sm" style="width:auto;">
                    <option value="30" selected>30 ngày gần nhất</option>
                    <option value="60">60 ngày gần nhất</option>
                    <option value="90">90 ngày gần nhất</option>
                </select>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                <table class="table table-sm table-striped mb-0">
                    <thead class="table-light">
                    <tr id="cust-head">
                        <th>Ngày</th>
                        <th>Khách hàng</th>
                        <th>Loại</th>
                        <th>Tỷ lệ NT/NS</th>
                        <th>NS ĐH 1 (m³)</th>
                        <th>NS ĐH 2 (m³)</th>
                        <th>NS ĐH 3 (m³)</th>
                        <th>NT (m³)</th>
                        <th>Nguồn NT</th>
                    </tr>
                    </thead>
                    <tbody id="cust-body">
                    <tr><td class="text-center py-3" colspan="9">Đang tải...</td></tr>
                    </tbody>
                </table>
                </div>
            </div>
            <div class="card-footer d-flex justify-content-between align-items-center">
                <small id="cust-summary" class="text-muted">—</small>
                <nav><ul id="cust-pagination" class="pagination pagination-sm mb-0"></ul></nav>
            </div>
</div>

    </div>
    
    <!-- Water Tanks Tab -->
    <div class="tab-pane fade" id="tanks" role="tabpanel">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-layer-group me-2"></i>Mức nước bể chứa</h5>
                <small class="text-muted">Nhập mức nước hiện tại của các bể chứa</small>
            </div>
            <div class="card-body">
                <form id="tanksForm" method="POST" action="{{ url_for('submit_tank_levels') }}">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="tank-date" class="form-label">Ngày</label>
                            <input type="date" class="form-control" id="tank-date" name="date" value="{{ date.today() }}" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        {% for tank in tanks %}
                        <div class="col-md-4 mb-3">
                            <div class="card {% if tank.tank_type == 'clean_water' %}border-success{% else %}border-info{% endif %}">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        {{ tank.name }}
                                        {% if tank.tank_type == 'clean_water' %}
                                        <span class="badge bg-success">Nước sạch</span>
                                        {% else %}
                                        <span class="badge bg-info">Nước thô</span>
                                        {% endif %}
                                    </h6>
                                    <div class="mb-2">
                                        <label class="form-label">Mức nước hiện tại (m³)</label>
                                        <input type="number" class="form-control" name="level_{{ tank.id }}" 
                                               step="0.1" min="0" max="{{ tank.capacity }}" 
                                               placeholder="0 - {{ tank.capacity }}">
                                        <input type="hidden" name="tank_ids" value="{{ tank.id }}">
                                    </div>
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" style="width: 0%" 
                                             data-tank-id="{{ tank.id }}" data-capacity="{{ tank.capacity }}">0%</div>
                                    </div>
                                    <small class="text-muted">
                                        Dung tích tối đa: {{ tank.capacity|round|int }} m³
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Lưu mức nước bể chứa
                        </button>
                    </div>
                    <!-- Lịch sử bể chứa -->
                    <div class="card mt-4">
                        <div class="card-header d-flex flex-wrap gap-2 align-items-center justify-content-between">
                            <h6 class="mb-0"><i class="fas fa-table me-2"></i>Lịch sử bể chứa theo ngày</h6>
                            <select id="tanks-range" class="form-select form-select-sm" style="width:auto;">
                            <option value="30" selected>30 ngày gần nhất</option>
                            <option value="60">60 ngày gần nhất</option>
                            <option value="90">90 ngày gần nhất</option>
                            </select>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                            <table class="table table-sm table-striped mb-0">
                                <thead class="table-light">
                                <tr id="tanks-head">
                                    <th>Ngày</th>
                                    <!-- các cột bể sẽ được dựng động -->
                                </tr>
                                </thead>
                                <tbody id="tanks-body">
                                <tr><td class="text-center py-3" colspan="999">Đang tải...</td></tr>
                                </tbody>
                            </table>
                            </div>
                        </div>
                        <div class="card-footer d-flex justify-content-between align-items-center">
                            <small id="tanks-summary" class="text-muted">—</small>
                            <nav><ul id="tanks-pagination" class="pagination pagination-sm mb-0"></ul></nav>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
    <script>
    window.DATA_ENTRY_CONFIG = {
        // endpoint tồn tại/ghi đè
        cleanWaterExists: "{{ url_for('clean_water_plant_exists') }}",
        wellProductionExists: "{{ url_for('well_production_exists') }}",
        wastewaterExists: "{{ url_for('wastewater_plant_exists') }}",
        customerReadingsExists: "{{ url_for('data_entry.customer_readings_exists') }}",
        tankLevelExists: "{{ url_for('data_entry.water_tank_level_exists') }}",

        // endpoint lịch sử
        wellsPivotApi: "/api/well-productions/history/pivot",
        cleanWaterHistoryApi: "/api/clean-water/consumption/history",
        tanksPivotApi: "/api/water-tanks/history/pivot",
        wastewaterPivotApi: "/api/wastewater/history/pivot",
        customerHistoryApi: "/api/customer-readings/history",

        // selectors các tab 
        selectors: {
        tabs: '#dataEntryTabs button[data-bs-toggle="tab"]',
        wells:   { tab: '#wells-tab', pane: '#wells',
                    head: '#wells-head', body: '#wells-body', summary: '#wells-summary',
                    pagination: '#wells-pagination', range: '#wells-range' },
        clean:   { tab: '#clean-water-tab', pane: '#clean-water',
                    head: '#cw-head', body: '#cw-body', summary: '#cw-summary',
                    pagination: '#cw-pagination', range: '#cw-range',
                    form: '#cleanWaterForm' },
        tanks:   { tab: '#tanks-tab', pane: '#tanks',
                    head: '#tanks-head', body: '#tanks-body', summary: '#tanks-summary',
                    pagination: '#tanks-pagination', range: '#tanks-range',
                    form: '#tanksForm' },
        wellsForm: '#wellForm',
        customersForm: '#customerForm',
        customersHistory: {
            head: '#cust-head', body: '#cust-body', summary: '#cust-summary',
            pagination: '#cust-pagination',
            range: '#cust-range', type: '#cust-type', search: '#cust-search',
            tab: '#customers-tab', pane: '#customers'
        }
        }
    };
    </script>

    <script src="{{ url_for('static', filename='js/data_entry.js') }}"></script>
{% endblock %}
