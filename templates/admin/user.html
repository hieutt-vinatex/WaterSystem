{% block content %}
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5><i class="fas fa-users me-2"></i>Quản lý người dùng</h5>
    <a class="btn btn-primary btn-sm" href="{{ url_for('new_user') }}">
      <i class="fas fa-plus me-2"></i>Thêm người dùng
    </a>
  </div>
  <div class="card-body">
    <div class="row mb-3">
      <div class="col-md-6">
        <input type="text" class="form-control" id="user-search-admin" placeholder="Tìm kiếm người dùng...">
      </div>
      <div class="col-md-3">
        <select class="form-select" id="user-filter-role">
          <option value="">Tất cả vai trò</option>
          <option value="data_entry">Nhập liệu</option>
          <option value="plant_manager">Quản lý nhà máy</option>
          <option value="admin">Quản trị</option>
        </select>
      </div>
      <div class="col-md-3">
        <select class="form-select" id="user-filter-status">
          <option value="">Tất cả trạng thái</option>
          <option value="active">Hoạt động</option>
          <option value="inactive">Ngưng hoạt động</option>
        </select>
      </div>
    </div>

    <div class="text-muted mb-2">
      Tổng: {{ users|length if users is defined else 0 }} người dùng
    </div>

    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>ID</th>
            <th>Tên đăng nhập</th>
            <th>Họ và tên</th>
            <th>Email</th>
            <th>Vai trò</th>
            <th>Trạng thái</th>
            <th>Thao tác</th>
          </tr>
        </thead>
        <tbody id="users-table-body">
          {% for u in users %}
          {# Chuẩn hóa role và active #}
          {% set role_value = (u.role.name if (u.role is not none and (u.role.name is defined)) else u.role) %}
          {% set active_value = (u.is_active if (u.is_active is defined) else (u.active if (u.active is defined) else False)) %}

          <tr class="user-admin-row"
              data-status="{{ 'active' if active_value else 'inactive' }}"
               data-role="{{ (role_value or '')|lower }}">
            <td>{{ u.id }}</td>
            <td><strong>{{ u.username }}</strong></td>
            <td>{{ u.full_name or '-' }}</td>
            <td>{{ u.email or '-' }}</td>
            <td>
             {% if role_value == 'ADMIN' %}
                <span class="badge bg-danger">Quản trị</span>
             {% elif role_value == 'PLANT_MANAGER' %}
                <span class="badge bg-info">Quản lý nhà máy</span>
             {% elif role_value == 'LEADERSHIP' %}
                <span class="badge bg-warning">Ban Lãnh Đạo</span>
             {% elif role_value == 'ACCOUNTING' %}
                <span class="badge bg-info">Kế toán</span>
             {% elif role_value == 'DATA_ENTRY' %}
               <span class="badge bg-secondary">Nhập liệu</span>
             {% else %}
               <span class="badge bg-secondary">{{ (role_value or 'UNKNOWN')|replace('_',' ') }}</span>
              {% endif %}
            </td>
            <td>
              {% if active_value %}
                <span class="badge bg-success">Hoạt động</span>
              {% else %}
                <span class="badge bg-secondary">Ngưng</span>
              {% endif %}
            </td>
            <td class="text-nowrap">
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('admin.edit_user', user_id=u.id) }}">
                <i class="fas fa-edit"></i>
              </a>
              <form method="post" action="{{ url_for('admin.delete_user', user_id=u.id) }}" style="display:inline"
                    onsubmit="return confirm('Xác nhận xóa người dùng #{{ u.id }}: {{ u.username }} ?');">
                <button type="submit" class="btn btn-sm btn-outline-danger" title="Xóa">
                  <i class="fas fa-trash"></i>
                </button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="7" class="text-center">Chưa có người dùng.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}