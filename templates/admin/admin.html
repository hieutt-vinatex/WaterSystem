{% extends "base.html" %}

{% block title %}Qu·∫£n tr·ªã h·ªá th·ªëng - H·ªá th·ªëng qu·∫£n l√Ω n∆∞·ªõc Ph·ªë N·ªëi{% endblock %}

{% block extra_head %}
<style>
    .stat-card {
        border: none;
        border-radius: 14px;
        padding: .9rem 1.25rem;
        box-shadow: 0 4px 10px rgba(0, 0, 0, .06);
        transition: transform .2s, box-shadow .2s;
        text-align: left;
        /* üëà canh tr√°i to√†n n·ªôi dung */
        min-height: 92px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 18px rgba(0, 0, 0, .08);
    }

    /* Pastel m√†u n·ªÅn */
    .stat-card.users {
        background: #edf3ff;
        color: #0d47a1;
    }

    .stat-card.customers {
        background: #fff8e6;
        color: #b36b00;
    }

    .stat-card.wells {
        background: #edfff1;
        color: #1b5e20;
    }

    .stat-card.tanks {
        background: #ffeaf1;
        color: #ad1457;
    }

    /* H√†ng icon + s·ªë */
    .stat-top {
        display: grid;
        grid-template-columns: auto 1fr;
        /* c·ªôt 1: icon | c·ªôt 2: v√πng linh ho·∫°t */
        align-items: center;
        column-gap: .9rem;
        /* kho·∫£ng c√°ch nh·ªè g·ªçn gi·ªØa icon v√† s·ªë */
    }

    .stat-icon {
        font-size: clamp(18px, 2.2vw, 22px);
        opacity: 0.9;
        margin: 0;
    }

    .stat-value {
        font-size: clamp(24px, 3.2vw, 36px);
        font-weight: 700;
        line-height: 1;
        justify-self: right;
    }

    .stat-label {
        font-size: .9rem;
        font-weight: 600;
        opacity: .9;
        margin-top: .2rem;
        text-align: left;
        /* s√°t h∆°n v√† canh gi·ªØa d∆∞·ªõi s·ªë */
    }
</style>


{% endblock %}


{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-cogs text-primary me-2"></i>Qu·∫£n tr·ªã h·ªá th·ªëng</h1>
        <p class="text-muted">Qu·∫£n l√Ω ng∆∞·ªùi d√πng, kh√°ch h√†ng v√† c·∫•u h√¨nh h·ªá th·ªëng</p>
    </div>
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab=='users' %}active{% endif %}" id="users-tab" data-bs-toggle="tab"
            data-bs-target="#users" type="button" role="tab">
            <i class="fas fa-users me-2"></i>Ng∆∞·ªùi d√πng
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab=='customers' %}active{% endif %}" id="customers-tab"
            data-bs-toggle="tab" data-bs-target="#customers" type="button" role="tab">
            <i class="fas fa-building me-2"></i>Kh√°ch h√†ng
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab=='wells' %}active{% endif %}" id="wells-tab" data-bs-toggle="tab"
            data-bs-target="#wells" type="button" role="tab">
            <i class="fas fa-water me-2"></i>Gi·∫øng khoan
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab=='tanks' %}active{% endif %}" id="tanks-tab" data-bs-toggle="tab"
            data-bs-target="#tanks" type="button" role="tab">
            <i class="fas fa-database me-2"></i>B·ªÉ ch·ª©a
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab=='settings' %}active{% endif %}" id="settings-tab" data-bs-toggle="tab"
            data-bs-target="#settings" type="button" role="tab">
            <i class="fas fa-cog me-2"></i>C·∫•u h√¨nh
        </button>
    </li>
</ul>

<div class="tab-content" id="adminTabsContent">

    <!-- ====================== System Statistics ====================== -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="section-title">
                <!-- <span class="title-ico"><i class="fas fa-chart-bar"></i></span> -->
                <!-- <span>Th·ªëng k√™ h·ªá th·ªëng</span> -->
            </div>
        </div>

        <div class="col-12">
            <div class="row g-3 row-cols-2 row-cols-md-4">
                <div class="col">
                    <div class="stat-card users h-100">
                        <div class="stat-top">
                            <span class="stat-icon"><i class="fas fa-user"></i></span>
                            <span class="stat-value">{{ users|length }}</span>
                        </div>
                        <div class="stat-label">Ng∆∞·ªùi d√πng</div>
                    </div>
                </div>

                <div class="col">
                    <div class="stat-card customers h-100">
                        <div class="stat-top">
                            <span class="stat-icon"><i class="fas fa-building"></i></span>
                            <span class="stat-value">{{ customers|length }}</span>
                        </div>
                        <div class="stat-label">Kh√°ch h√†ng</div>
                    </div>
                </div>

                <div class="col">
                    <div class="stat-card wells h-100">
                        <div class="stat-top">
                            <span class="stat-icon"><i class="fas fa-water"></i></span>
                            <span class="stat-value">{{ wells|length }}</span>
                        </div>
                        <div class="stat-label">Gi·∫øng khoan</div>
                    </div>
                </div>

                <div class="col">
                    <div class="stat-card tanks h-100">
                        <div class="stat-top">
                            <span class="stat-icon"><i class="fas fa-database"></i></span>
                            <span class="stat-value">{{ tanks|length }}</span>
                        </div>
                        <div class="stat-label">B·ªÉ ch·ª©a</div>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <hr class="my-4">

    <!-- ====================== Users Tab ====================== -->
    <div class="tab-pane fade {% if active_tab=='users' %}show active{% endif %}" id="users" role="tabpanel">
        {% include 'admin/user.html' %}
    </div>

    <!-- ====================== Customers Tab ====================== -->
    <div class="tab-pane fade {% if active_tab=='customers' %}show active{% endif %}" id="customers" role="tabpanel">
        {% include 'admin/customer.html' %}
    </div>

    <!-- ====================== Wells Tab ====================== -->
    <div class="tab-pane fade {% if active_tab=='wells' %}show active{% endif %}" id="wells" role="tabpanel">
        {% include 'admin/well.html' %}
    </div>

    <!-- ====================== Tanks Tab ====================== -->
    <div class="tab-pane fade {% if active_tab=='tanks' %}show active{% endif %}" id="tanks" role="tabpanel">
        {% include 'admin/water_tank.html' %}
    </div>

    <!-- Settings Tab -->
    <div class="tab-pane fade {% if active_tab=='settings' %}show active{% endif %}" id="settings" role="tabpanel">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-calendar me-2"></i>C·∫•u h√¨nh chu k·ª≥ ch·ªët s·ªë</h6>
                    </div>
                    <div class="card-body">
                        <form>
                            <div class="mb-3">
                                <label class="form-label">Ng√†y ch·ªët h√†ng th√°ng</label>
                                <input type="number" class="form-control" value="25" min="1" max="31">
                                <small class="text-muted">Ng√†y ch·ªët s·ªë h√†ng th√°ng (t·ª´ 25 th√°ng tr∆∞·ªõc ƒë·∫øn 25 th√°ng sau)</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Gi·ªù ghi s·ªë h√†ng ng√†y</label>
                                <input type="time" class="form-control" value="16:00">
                                <small class="text-muted">Th·ªùi gian ghi s·ªë h√†ng ng√†y (~16h)</small>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>L∆∞u c·∫•u h√¨nh
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-dollar-sign me-2"></i>C·∫•u h√¨nh ƒë∆°n gi√°</h6>
                    </div>
                    <div class="card-body">
                        <form>
                            <div class="mb-3">
                                <label class="form-label">ƒê∆°n gi√° n∆∞·ªõc s·∫°ch (VNƒê/m¬≥)</label>
                                <input type="number" class="form-control" value="8000" min="0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">ƒê∆°n gi√° n∆∞·ªõc th·∫£i (VNƒê/m¬≥)</label>
                                <input type="number" class="form-control" value="12000" min="0">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">T·ª∑ l·ªá m·∫∑c ƒë·ªãnh NT/NS</label>
                                <input type="number" class="form-control" value="0.8" step="0.1" min="0" max="1">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>L∆∞u ƒë∆°n gi√°
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Ng∆∞·ª°ng c·∫£nh b√°o</h6>
                    </div>
                    <div class="card-body">
                        <form>
                            <div class="mb-3">
                                <label class="form-label">M·ª©c n∆∞·ªõc b·ªÉ th·∫•p (%)</label>
                                <input type="number" class="form-control" value="20" min="0" max="100">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">S·∫£n l∆∞·ª£ng gi·∫øng b·∫•t th∆∞·ªùng (%)</label>
                                <input type="number" class="form-control" value="50" min="0" max="100">
                                <small class="text-muted">C·∫£nh b√°o khi s·∫£n l∆∞·ª£ng gi·∫øng < % c√¥ng su·∫•t</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Ti√™u hao ƒëi·ªán b·∫•t th∆∞·ªùng (%)</label>
                                <input type="number" class="form-control" value="120" min="100">
                                <small class="text-muted">C·∫£nh b√°o khi ti√™u hao > % ƒë·ªãnh m·ª©c</small>
                            </div>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save me-2"></i>L∆∞u ng∆∞·ª°ng c·∫£nh b√°o
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-shield-alt me-2"></i>B·∫£o m·∫≠t h·ªá th·ªëng</h6>
                    </div>
                    <div class="card-body">
                        <form>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enable-audit-log" checked>
                                    <label class="form-check-label" for="enable-audit-log">
                                        Ghi nh·∫≠t k√Ω ho·∫°t ƒë·ªông
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="require-approval" checked>
                                    <label class="form-check-label" for="require-approval">
                                        Y√™u c·∫ßu ph√™ duy·ªát tr∆∞·ªõc khi kh√≥a k·ª≥
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Th·ªùi gian t·ª± ƒë·ªông logout (ph√∫t)</label>
                                <input type="number" class="form-control" value="60" min="15">
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-2"></i>L∆∞u c·∫•u h√¨nh b·∫£o m·∫≠t
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



{% endblock %}

{% block extra_scripts %}
<script>
    // ----- Users tab: unified filter (search + role + status) -----
    (function () {
        const userSearchEl = document.getElementById('user-search-admin');
        const userRoleEl = document.getElementById('user-filter-role');
        const userStatusEl = document.getElementById('user-filter-status');

        function applyUserFilters() {
            const rows = document.querySelectorAll('.user-admin-row');
            if (!rows.length) return;
            const searchTerm = (userSearchEl && userSearchEl.value ? userSearchEl.value.toLowerCase() : '');
            const roleVal = (userRoleEl && userRoleEl.value) || '';
            const statusVal = (userStatusEl && userStatusEl.value) || '';

            rows.forEach(row => {
                const username = (row.cells[1]?.textContent || '').toLowerCase();
                const fullName = (row.cells[2]?.textContent || '').toLowerCase();
                const matchesSearch = !searchTerm || username.includes(searchTerm) || fullName.includes(searchTerm);
                const matchesRole = !roleVal || (row.dataset.role === roleVal);
                const matchesStatus = !statusVal || (row.dataset.status === statusVal);
                row.style.display = (matchesSearch && matchesRole && matchesStatus) ? '' : 'none';
            });
        }

        if (userSearchEl) userSearchEl.addEventListener('input', applyUserFilters);
        if (userRoleEl) userRoleEl.addEventListener('change', applyUserFilters);
        if (userStatusEl) userStatusEl.addEventListener('change', applyUserFilters);

        // Run once on load to normalize
        applyUserFilters();
    })();

    // Customer search and filter functionality
    document.getElementById('customer-search-admin').addEventListener('input', function () {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('.customer-admin-row');

        rows.forEach(row => {
            const companyName = row.cells[1].textContent.toLowerCase();
            const contactPerson = row.cells[2].textContent.toLowerCase();
            if (companyName.includes(searchTerm) || contactPerson.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    document.getElementById('customer-filter-admin').addEventListener('change', function () {
        const filterValue = this.value;
        const rows = document.querySelectorAll('.customer-admin-row');

        rows.forEach(row => {
            if (filterValue === '') {
                row.style.display = '';
            } else if (filterValue === 'active' && row.dataset.status === 'active') {
                row.style.display = '';
            } else if (filterValue === 'inactive' && row.dataset.status === 'inactive') {
                row.style.display = '';
            } else if (filterValue === 'daily' && row.dataset.reading === 'daily') {
                row.style.display = '';
            } else if (filterValue === 'monthly' && row.dataset.reading === 'monthly') {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    // document.addEventListener('DOMContentLoaded', function () {
    //   // M·∫∑c ƒë·ªãnh k√≠ch ho·∫°t tab Users n·∫øu kh√¥ng c√≥ hash
    //   const defaultTabBtn = document.getElementById('users-tab');
    //   if (defaultTabBtn && !window.location.hash) {
    //     new bootstrap.Tab(defaultTabBtn).show();
    //   }
    //   const hash = window.location.hash;
    //   if (hash === '#customers') {
    //     const btn = document.getElementById('customers-tab');
    //     if (btn) {
    //       new bootstrap.Tab(btn).show();
    //       window.scrollTo({top:0, left:0, behavior:'auto'});
    //     }
    //   }
    // });

</script>
{% endblock %}